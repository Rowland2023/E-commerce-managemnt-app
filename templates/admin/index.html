{% extends "admin/index.html" %}
{% load static %}

{% block content %}
{% if low_stock_count > 0 %}
<div class="alert alert-low-stock">
    <h3 class="alert-title">
        <span class="alert-icon">⚠️</span> Low Stock Alert ({{ low_stock_count }} items)
    </h3>
    <ul class="alert-list">
        {% for product in low_stock_products %}
        <li>
            <strong>{{ product.name }}</strong>: Only <strong>{{ product.stock_quantity }}</strong> left.
            <a href="{% url 'admin:store_product_change' product.pk %}" class="alert-link">Update Stock →</a>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="dashboard-grid">
    <!-- Revenue Chart -->
    <div class="card card-large">
        <h3 class="card-title">Daily Revenue (Last 7 Days)</h3>
        <div class="chart-container">
            <canvas id="salesChart"></canvas>
        </div>
    </div>

    <!-- Top Products -->
    <div class="card card-small">
        <h3 class="card-title">Top 5 Selling Products</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Sold</th>
                </tr>
            </thead>
            <tbody>
                {% for item in top_products %}
                <tr>
                    <td>{{ item.product__name }}</td>
                    <td class="bold">{{ item.total_sold }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="2" class="table-empty">No data.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Recent Transactions -->
<div class="card">
    <h3 class="card-title">Recent Transactions (Last 5)</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Status</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in recent_payments %}
            <tr>
                <td>#{{ payment.order.id }}</td>
                <td>{{ payment.order.customer.first_name }} {{ payment.order.customer.last_name }}</td>
                <td class="bold">${{ payment.amount }}</td>
                <td>{{ payment.method }}</td>
                <td>
                    <span class="status {% if payment.status == 'pending' %}status-pending{% else %}status-success{% endif %}">
                        {{ payment.status|upper }}
                    </span>
                </td>
                <td class="muted">{{ payment.created_at|timesince }} ago</td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="table-empty">No transactions found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const rawData = JSON.parse('{{ chart_data|safe }}');
        const ctx = document.getElementById('salesChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: rawData.map(d => d.day),
                datasets: [{
                    label: 'Revenue ($)',
                    data: rawData.map(d => d.total),
                    borderColor: '#417690',
                    backgroundColor: 'rgba(65, 118, 144, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    });
</script>

{{ block.super }}
{% endblock %}
